{% extends 'inicio/index.html' %}

{% block content %}

  <h1>PREVENCION DE PERDIDAS - STATUS GENERAL</h1>
  
<!--
  <form method="GET" action="">
    <label><strong>Fecha exacta:</strong></label>
    <input type="date" name="fecha" value="{{ fecha_actual }}" onchange="this.form.submit()">
-->
    
    <form method="get" style="display: inline-block;">
        <label><strong>Mes:</strong></label>

        <select name="mes" onchange="this.form.submit()" class="form-select">
            <option value="">Todos</option>
            {% for m in meses_unicos %}
                <option value="{{ m }}" {% if m == mes_actual %}selected{% endif %}>
                    {{ m }}
                </option>
            {% endfor %}
        </select>
    </form>

<!--    <button class="btn btn-primary" type="submit">
    <button class="btn btn-primary" type="submit">
      <label><strong>Día de semana:</strong></label>
    </button>
--> 

    <!--
    <select name="dia" onchange="this.form.submit()">
        <option value="">Todos</option>
        <option value="0" {% if dia_actual == '0' %}selected{% endif %}>Lunes</option>
        <option value="1" {% if dia_actual == '1' %}selected{% endif %}>Martes</option>
        <option value="2" {% if dia_actual == '2' %}selected{% endif %}>Miércoles</option>
        <option value="3" {% if dia_actual == '3' %}selected{% endif %}>Jueves</option>
        <option value="4" {% if dia_actual == '4' %}selected{% endif %}>Viernes</option>
        <option value="5" {% if dia_actual == '5' %}selected{% endif %}>Sábado</option>
        <option value="6" {% if dia_actual == '6' %}selected{% endif %}>Domingo</option>
    </select>
    

    <button class="btn btn-primary" type="submit">Aplicar</button>
</form>
-->

  <!-- Tarjeta de contador -->
  <!-- BARRA 1 -->
  <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <!-- EN ESPERA -->
      <div style="background-color: #f59700ff; color: white; padding: 15px; width: 200px; 
                  text-align: center; border-radius: 10px;">
          <strong>DESAPARECIDAS ACTUALES</strong><br>
          <span style="font-size: 24px;">{{ casos_espera }}</span>
      </div>

      <!-- ROBADAS -->
      <div style="background-color: #004080; color: white; padding: 15px; width: 200px; 
                  text-align: center; border-radius: 10px;">
          <strong>ROBADAS TOTALES</strong><br>
          <span style="font-size: 24px;">{{ casos_robada }}</span>
      </div>

      <!-- RECUPERADAS -->
      <div style="background-color: #00530fff; color: white; padding: 15px; width: 150px; 
                  text-align: center; border-radius: 10px;">
          <strong>RECUPERADAS</strong><br>
          <span style="font-size: 24px;">{{ casos_robada_recuperada }}</span>
      </div>

      <!-- COMISARIA -->
      <div style="background-color: rgb(133, 133, 133); color: white; padding: 15px; width: 150px; 
                  text-align: center; border-radius: 10px;">
          <strong>COMISARIA</strong><br>
          <span style="font-size: 24px;">{{ comisaria }}</span>
      </div>

      <!-- VANDALISMO -->
      <div style="background-color: rgb(133, 133, 133); color: white; padding: 15px; width: 150px; 
                  text-align: center; border-radius: 10px;">
          <strong>VANDALISMO</strong><br>
          <span style="font-size: 24px;">{{ vandalismo }}</span>
      </div>
  </div>

    <!-- CONTENEDOR FLEX -->
    <div style="
        display: flex;
        gap: 20px;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
    ">

    <!-- GRAFICO ROBOS -->
        <div style="width: 48%; height: 300px; margin: 10px">
            <h3 style="text-align:center;">Robos por Mes (según Fecha Robada)</h3>
            <canvas id="graficoRobosMes"></canvas>
        </div>

    <!-- GRAFICO RECUPEROS -->
        <div style="width: 48%; height: 300px; margin: 10px">
            <h3 style="text-align:center;">Recuperos por Mes (según Fecha de Recupero)</h3>
            <canvas id="graficoRecuperosMes"></canvas>
        </div>

    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Plugin datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <script>
    const ctxRobos = document.getElementById("graficoRobosMes");

    new Chart(ctxRobos, {
        type: 'bar',
        data: {
            labels: {{ meses_robos|safe }},
            datasets: [{
                label: 'Cantidad de robos',
                data: {{ cant_robos|safe }},
                backgroundColor: 'rgba(180, 0, 0, 0.6)',
                borderColor: 'rgba(180, 0, 0, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#000',
                    font: { weight: 'bold', size: 10 }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    </script>

    <!-- Graficos de Recuperos -->


    <script>
    const ctxRecuperos = document.getElementById("graficoRecuperosMes");

    new Chart(ctxRecuperos, {
        type: 'bar',
        data: {
            labels: {{ meses_recuperos|safe }},
            datasets: [{
                label: 'Cantidad de recuperos',
                data: {{ cant_recuperos|safe }},
                backgroundColor: 'rgba(0, 130, 39, 0.6)',
                borderColor: 'rgb(1, 113, 16)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#000',
                    font: { weight: 'bold', size: 10 }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
    </script>

    <!-- INTENTO Mapa de puntos GPS -->

    <!-- Leaflet -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <div id="map"
        style="height: 500px; width: 100%; border-radius: 12px; margin-top: 60px; margin-left: auto; margin-right: auto;">
    </div>

    <script>
        const puntos = {{ puntos_gps|safe }};
        console.log("Puntos GPS:", puntos);

        if (puntos.length > 0) {

            const map = L.map('map').setView([-34.61, -58.38], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            const bounds = [];

            puntos.forEach(p => {
                const lat = parseFloat(p.lat);
                const lng = parseFloat(p.lng);

                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.circleMarker([lat, lng], {
                        radius: 4,
                        color: '#d90429',
                        fillOpacity: 0.7
                    }).addTo(map);

                    bounds.push([lat, lng]);
                }
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds);
            }

        } else {
            console.warn("No hay puntos GPS para mostrar");
        }
    </script>

{% endblock %}

